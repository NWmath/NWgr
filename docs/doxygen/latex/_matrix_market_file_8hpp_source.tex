\hypertarget{_matrix_market_file_8hpp_source}{}\doxysection{Matrix\+Market\+File.\+hpp}
\label{_matrix_market_file_8hpp_source}\index{/Users/lums/NWmath/NWgr/include/nwgraph/io/MatrixMarketFile.hpp@{/Users/lums/NWmath/NWgr/include/nwgraph/io/MatrixMarketFile.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{// }}
\DoxyCodeLine{2 \textcolor{comment}{// This file is part of NW Graph (aka GraphPack) }}
\DoxyCodeLine{3 \textcolor{comment}{// (c) Pacific Northwest National Laboratory 2018-\/2021 }}
\DoxyCodeLine{4 \textcolor{comment}{// (c) University of Washington 2018-\/2021 }}
\DoxyCodeLine{5 \textcolor{comment}{// }}
\DoxyCodeLine{6 \textcolor{comment}{// Licensed under terms of include LICENSE file }}
\DoxyCodeLine{7 \textcolor{comment}{// }}
\DoxyCodeLine{8 \textcolor{comment}{// Authors: }}
\DoxyCodeLine{9 \textcolor{comment}{//     Andrew Lumsdaine }}
\DoxyCodeLine{10 \textcolor{comment}{//     Kevin Deweese    }}
\DoxyCodeLine{11 \textcolor{comment}{//}}
\DoxyCodeLine{12 }
\DoxyCodeLine{13 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{14 }
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <cstdio>}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#include <cstring>}}
\DoxyCodeLine{17 \textcolor{preprocessor}{\#include <fcntl.h>}}
\DoxyCodeLine{18 \textcolor{preprocessor}{\#include <filesystem>}}
\DoxyCodeLine{19 \textcolor{preprocessor}{\#include <sys/mman.h>}}
\DoxyCodeLine{20 \textcolor{preprocessor}{\#include <sys/stat.h>}}
\DoxyCodeLine{21 \textcolor{preprocessor}{\#include <sys/types.h>}}
\DoxyCodeLine{22 \textcolor{preprocessor}{\#include <tuple>}}
\DoxyCodeLine{23 \textcolor{preprocessor}{\#include <unistd.h>}}
\DoxyCodeLine{24 }
\DoxyCodeLine{25 \textcolor{keyword}{extern} \textcolor{stringliteral}{"{}C"{}} \{}
\DoxyCodeLine{26 \textcolor{preprocessor}{\#include "{}mmio\_nist.h"{}}}
\DoxyCodeLine{27 \}}
\DoxyCodeLine{28 }
\DoxyCodeLine{29 \textcolor{keyword}{namespace }mmio \{}
\DoxyCodeLine{30 \textcolor{keyword}{template} <\textcolor{keyword}{typename} It>}
\DoxyCodeLine{31 \textcolor{keyword}{class }\mbox{\hyperlink{classmmio_1_1_range}{Range}} \{}
\DoxyCodeLine{32   It begin\_;}
\DoxyCodeLine{33   It end\_;}
\DoxyCodeLine{34 }
\DoxyCodeLine{35 \textcolor{keyword}{public}:}
\DoxyCodeLine{36   \mbox{\hyperlink{classmmio_1_1_range}{Range}}(It begin, It end) : begin\_(begin), end\_(end) \{\}}
\DoxyCodeLine{37   It begin()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} begin\_; \}}
\DoxyCodeLine{38   It end()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} end\_; \}}
\DoxyCodeLine{39 \};}
\DoxyCodeLine{40 }
\DoxyCodeLine{41 \textcolor{keyword}{class }\mbox{\hyperlink{classmmio_1_1_matrix_market_file}{MatrixMarketFile}} final \{}
\DoxyCodeLine{42   \textcolor{keywordtype}{int} fd\_  = -\/1;    \textcolor{comment}{// .mtx file descriptor}}
\DoxyCodeLine{43   \textcolor{keywordtype}{int} n\_   = 0;     \textcolor{comment}{// number of rows}}
\DoxyCodeLine{44   \textcolor{keywordtype}{int} m\_   = 0;     \textcolor{comment}{// number of columns}}
\DoxyCodeLine{45   \textcolor{keywordtype}{int} nnz\_ = 0;     \textcolor{comment}{// number of edges}}
\DoxyCodeLine{46 }
\DoxyCodeLine{47   \textcolor{keywordtype}{char}* base\_ = \textcolor{keyword}{nullptr};    \textcolor{comment}{// base pointer to mmap-\/ed file}}
\DoxyCodeLine{48   \textcolor{keywordtype}{long}  i\_    = 0;          \textcolor{comment}{// byte offset of the first edge}}
\DoxyCodeLine{49   \textcolor{keywordtype}{long}  e\_    = 0;          \textcolor{comment}{// bytes in the mmap-\/ed file}}
\DoxyCodeLine{50 }
\DoxyCodeLine{51   MM\_typecode type\_;}
\DoxyCodeLine{52 }
\DoxyCodeLine{53 \textcolor{keyword}{public}:}
\DoxyCodeLine{54   \mbox{\hyperlink{classmmio_1_1_matrix_market_file}{MatrixMarketFile}}(std::filesystem::path path) : fd\_(open(path.c\_str(), O\_RDONLY)) \{}
\DoxyCodeLine{55     \textcolor{keywordflow}{if} (fd\_ < 0) \{}
\DoxyCodeLine{56       fprintf(stderr, \textcolor{stringliteral}{"{}open failed, \%d: \%s\(\backslash\)n"{}}, errno, strerror(errno));}
\DoxyCodeLine{57       std::terminate();}
\DoxyCodeLine{58     \}}
\DoxyCodeLine{59 }
\DoxyCodeLine{60     FILE* f = fdopen(fd\_, \textcolor{stringliteral}{"{}r"{}});}
\DoxyCodeLine{61     \textcolor{keywordflow}{if} (f == \textcolor{keyword}{nullptr}) \{}
\DoxyCodeLine{62       fprintf(stderr, \textcolor{stringliteral}{"{}fdopen failed, \%d: \%s\(\backslash\)n"{}}, errno, strerror(errno));}
\DoxyCodeLine{63       \textcolor{keywordflow}{goto} error;}
\DoxyCodeLine{64     \}}
\DoxyCodeLine{65 }
\DoxyCodeLine{66     \textcolor{keywordflow}{switch} (mm\_read\_banner(f, \&type\_)) \{}
\DoxyCodeLine{67       \textcolor{keywordflow}{case} MM\_PREMATURE\_EOF:       \textcolor{comment}{// if all items are not present on first line of file.}}
\DoxyCodeLine{68       \textcolor{keywordflow}{case} MM\_NO\_HEADER:           \textcolor{comment}{// if the file does not begin with "{}\%\%MatrixMarket"{}.}}
\DoxyCodeLine{69       \textcolor{keywordflow}{case} MM\_UNSUPPORTED\_TYPE:    \textcolor{comment}{// if not recongizable description.}}
\DoxyCodeLine{70         \textcolor{keywordflow}{goto} error;}
\DoxyCodeLine{71     \}}
\DoxyCodeLine{72 }
\DoxyCodeLine{73     \textcolor{keywordflow}{if} (!mm\_is\_coordinate(type\_)) \{}
\DoxyCodeLine{74       \textcolor{keywordflow}{goto} error;}
\DoxyCodeLine{75     \}}
\DoxyCodeLine{76 }
\DoxyCodeLine{77     \textcolor{keywordflow}{switch} (mm\_read\_mtx\_crd\_size(f, \&n\_, \&m\_, \&nnz\_)) \{}
\DoxyCodeLine{78       \textcolor{keywordflow}{case} MM\_PREMATURE\_EOF:    \textcolor{comment}{// if an end-\/of-\/file is encountered before processing these three values.}}
\DoxyCodeLine{79         \textcolor{keywordflow}{goto} error;}
\DoxyCodeLine{80     \}}
\DoxyCodeLine{81 }
\DoxyCodeLine{82     i\_ = ftell(f);}
\DoxyCodeLine{83     fseek(f, 0L, SEEK\_END);}
\DoxyCodeLine{84     e\_ = ftell(f);}
\DoxyCodeLine{85 }
\DoxyCodeLine{86     base\_ = \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{char}*\textcolor{keyword}{>}(mmap(\textcolor{keyword}{nullptr}, e\_, PROT\_READ, MAP\_PRIVATE, fd\_, 0));}
\DoxyCodeLine{87     \textcolor{keywordflow}{if} (base\_ == MAP\_FAILED) \{}
\DoxyCodeLine{88       fprintf(stderr, \textcolor{stringliteral}{"{}mmap failed, \%d: \%s\(\backslash\)n"{}}, errno, strerror(errno));}
\DoxyCodeLine{89       \textcolor{keywordflow}{goto} error;}
\DoxyCodeLine{90     \}}
\DoxyCodeLine{91 }
\DoxyCodeLine{92     \textcolor{keywordflow}{return};}
\DoxyCodeLine{93 }
\DoxyCodeLine{94   error:}
\DoxyCodeLine{95     close(fd\_);}
\DoxyCodeLine{96     std::terminate();}
\DoxyCodeLine{97   \};}
\DoxyCodeLine{98 }
\DoxyCodeLine{99   \mbox{\hyperlink{classmmio_1_1_matrix_market_file}{\string~MatrixMarketFile}}() \{ \mbox{\hyperlink{classmmio_1_1_matrix_market_file_ad85445697beca19901e616047fc2c875}{release}}(); \};}
\DoxyCodeLine{100 }
\DoxyCodeLine{102   \textcolor{keywordtype}{void} \mbox{\hyperlink{classmmio_1_1_matrix_market_file_ad85445697beca19901e616047fc2c875}{release}}() \{}
\DoxyCodeLine{103     \textcolor{keywordflow}{if} (base\_ \&\& munmap(base\_, e\_)) \{}
\DoxyCodeLine{104       fprintf(stderr, \textcolor{stringliteral}{"{}munmap failed, \%d: \%s\(\backslash\)n"{}}, errno, strerror(errno));}
\DoxyCodeLine{105     \}}
\DoxyCodeLine{106     base\_ = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{107 }
\DoxyCodeLine{108     \textcolor{keywordflow}{if} (fd\_ != -\/1 \&\& close(fd\_)) \{}
\DoxyCodeLine{109       fprintf(stderr, \textcolor{stringliteral}{"{}close(fd) failed, \%d: \%s\(\backslash\)n"{}}, errno, strerror(errno));}
\DoxyCodeLine{110     \}}
\DoxyCodeLine{111     fd\_ = -\/1;}
\DoxyCodeLine{112   \};}
\DoxyCodeLine{113 }
\DoxyCodeLine{115   \textcolor{keyword}{friend} \textcolor{keywordtype}{void} \mbox{\hyperlink{classmmio_1_1_matrix_market_file_ab0b71963f43840d3c3e46b9af4f46a9f}{release}}(\mbox{\hyperlink{classmmio_1_1_matrix_market_file}{MatrixMarketFile}}\& mm) \{ mm.\mbox{\hyperlink{classmmio_1_1_matrix_market_file_ad85445697beca19901e616047fc2c875}{release}}(); \}}
\DoxyCodeLine{116 }
\DoxyCodeLine{117   \textcolor{keywordtype}{int} getNRows()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} n\_; \}}
\DoxyCodeLine{118 }
\DoxyCodeLine{119   \textcolor{keywordtype}{int} getNCols()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} m\_; \}}
\DoxyCodeLine{120 }
\DoxyCodeLine{121   \textcolor{keywordtype}{int} getNEdges()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} nnz\_; \}}
\DoxyCodeLine{122 }
\DoxyCodeLine{123   \textcolor{keywordtype}{bool} isPattern()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} mm\_is\_pattern(type\_); \}}
\DoxyCodeLine{124 }
\DoxyCodeLine{125   \textcolor{keywordtype}{bool} isSymmetric()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} mm\_is\_symmetric(type\_); \}}
\DoxyCodeLine{126 }
\DoxyCodeLine{127   \textcolor{comment}{// Iterator over edges in the file.}}
\DoxyCodeLine{128   \textcolor{keyword}{template} <\textcolor{keyword}{typename}... Vs>}
\DoxyCodeLine{129   \textcolor{keyword}{class }\mbox{\hyperlink{classmmio_1_1_matrix_market_file_1_1iterator}{iterator}} \{}
\DoxyCodeLine{130     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* i\_;}
\DoxyCodeLine{131 }
\DoxyCodeLine{136     \textcolor{keyword}{template} <\textcolor{keyword}{typename} U>}
\DoxyCodeLine{137     \textcolor{keyword}{static} \textcolor{keyword}{constexpr} U get(\textcolor{keyword}{const} \textcolor{keywordtype}{char}*(\&i)) \{}
\DoxyCodeLine{138       U     v;}
\DoxyCodeLine{139       \textcolor{keywordtype}{char}* e;}
\DoxyCodeLine{140       \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (std::is\_same\_v<U, int>) \{}
\DoxyCodeLine{141         v = std::strtol(i, \&e, 10);}
\DoxyCodeLine{142       \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{143         v = std::strtod(i, \&e);}
\DoxyCodeLine{144       \}}
\DoxyCodeLine{145       i = e;}
\DoxyCodeLine{146       \textcolor{keywordflow}{return} v;}
\DoxyCodeLine{147     \}}
\DoxyCodeLine{148 }
\DoxyCodeLine{149   \textcolor{keyword}{public}:}
\DoxyCodeLine{150     \mbox{\hyperlink{classmmio_1_1_matrix_market_file_1_1iterator}{iterator}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* i) : i\_(i) \{\}}
\DoxyCodeLine{151 }
\DoxyCodeLine{152     std::tuple<int, int, Vs...> operator*()\textcolor{keyword}{ const }\{}
\DoxyCodeLine{153       \textcolor{keyword}{const} \textcolor{keywordtype}{char}* i = i\_;}
\DoxyCodeLine{154       \textcolor{keywordtype}{int}         u = get<int>(i) -\/ 1;}
\DoxyCodeLine{155       \textcolor{keywordtype}{int}         v = get<int>(i) -\/ 1;}
\DoxyCodeLine{156       \textcolor{keywordflow}{return} std::tuple(u, v, get<Vs>(i)...);}
\DoxyCodeLine{157     \}}
\DoxyCodeLine{158 }
\DoxyCodeLine{159     \mbox{\hyperlink{classmmio_1_1_matrix_market_file_1_1iterator}{iterator}}\& operator++() \{}
\DoxyCodeLine{160       ++(i\_ = std::strchr(i\_, \textcolor{charliteral}{'\(\backslash\)n'}));}
\DoxyCodeLine{161       \textcolor{keywordflow}{return} *\textcolor{keyword}{this};}
\DoxyCodeLine{162     \}}
\DoxyCodeLine{163 }
\DoxyCodeLine{164     \textcolor{keywordtype}{bool} operator!=(\textcolor{keyword}{const} \mbox{\hyperlink{classmmio_1_1_matrix_market_file_1_1iterator}{iterator}}\& b)\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} i\_ != b.i\_; \}}
\DoxyCodeLine{165   \};}
\DoxyCodeLine{166 }
\DoxyCodeLine{167   \textcolor{keyword}{template} <\textcolor{keyword}{typename}... Vs>}
\DoxyCodeLine{168   \mbox{\hyperlink{classmmio_1_1_matrix_market_file_1_1iterator}{iterator}}<Vs...> begin()\textcolor{keyword}{ const }\{}
\DoxyCodeLine{169     \textcolor{keywordflow}{return} \{base\_ + i\_\};}
\DoxyCodeLine{170   \}}
\DoxyCodeLine{171 }
\DoxyCodeLine{172   \textcolor{keyword}{template} <\textcolor{keyword}{typename}... Vs>}
\DoxyCodeLine{173   iterator<Vs...> end()\textcolor{keyword}{ const }\{}
\DoxyCodeLine{174     \textcolor{keywordflow}{return} \{base\_ + e\_\};}
\DoxyCodeLine{175   \}}
\DoxyCodeLine{176 }
\DoxyCodeLine{177   \textcolor{keyword}{template} <\textcolor{keyword}{typename}... Vs>}
\DoxyCodeLine{178   iterator<Vs...> at(\textcolor{keywordtype}{long} edge)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{179     \textcolor{keywordflow}{if} (edge == 0) \textcolor{keywordflow}{return} begin<Vs...>();}
\DoxyCodeLine{180     \textcolor{keywordflow}{if} (edge == nnz\_) \textcolor{keywordflow}{return} end<Vs...>();}
\DoxyCodeLine{181 }
\DoxyCodeLine{182     \textcolor{comment}{// Use the edge id to come up with an approximation of the byte to start}}
\DoxyCodeLine{183     \textcolor{comment}{// searching at, and then search backward to find the byte offset of the}}
\DoxyCodeLine{184     \textcolor{comment}{// nearest edge.}}
\DoxyCodeLine{185     \textcolor{keywordtype}{long} approx = (double(edge) / double(nnz\_)) * (e\_ -\/ i\_) + i\_;}
\DoxyCodeLine{186     \textcolor{keywordflow}{while} (i\_ <= approx \&\& base\_[approx] != \textcolor{charliteral}{'\(\backslash\)n'}) \{}
\DoxyCodeLine{187       -\/-\/approx;}
\DoxyCodeLine{188     \}}
\DoxyCodeLine{189     ++approx;}
\DoxyCodeLine{190     \textcolor{keywordflow}{return} \{base\_ + approx\};}
\DoxyCodeLine{191   \}}
\DoxyCodeLine{192 \};}
\DoxyCodeLine{193 }
\DoxyCodeLine{194 \textcolor{keyword}{template} <\textcolor{keyword}{typename}... Vs>}
\DoxyCodeLine{195 \textcolor{keyword}{auto} edges(\textcolor{keyword}{const} MatrixMarketFile\& mm, \textcolor{keywordtype}{int} j, \textcolor{keywordtype}{int} k) \{}
\DoxyCodeLine{196   \textcolor{keywordflow}{return} Range(mm.template at<Vs...>(j), mm.template at<Vs...>(k));}
\DoxyCodeLine{197 \}}
\DoxyCodeLine{198 \}    \textcolor{comment}{// namespace mmio}}

\end{DoxyCode}
